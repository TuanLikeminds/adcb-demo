name: Deploy PingDirectory to AKS
on:
  push:
    tags: pd-v**


jobs:
  Prepare:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout GitOps repository
      uses: actions/checkout@v4
  Deploy: 
    needs: Prepare
    runs-on: ubuntu-latest
    env:
      # AZURE_IDENTITY: ${{ vars.AZURE_IDENTITY || '2cf25ef0-3b61-4bd8-b433-d92d8addde3e' }}
      # AZURE_SUBSCRIPTION: ${{ vars.AZURE_SUBSCRIPTION || '881a577a-6e04-4569-966d-b0cdf6fe5c71' }}
      # AZURE_AKS_CLUSTER_NAME: ${{ vars.AZURE_AKS_CLUSTER_NAME || 'aks-ciam-dev-uan-60gqi9' }}
      # AZURE_AKS_CLUSTER_RESOURCE_GROUP: ${{ vars.AZURE_AKS_CLUSTER_RESOURCE_GROUP || 'rg-ciam-dev-uaenorth-aks' }}
      BASE_IMAGE_TAG: "2408"
      BASE_IMAGE_REPOSITORY: "pingidentity-base-images/pingdirectory"
      PRODUCT_NAME: "pingdirectory"
      ACR_REGISTRY_NAME: "likeminds"
      ACR_REGISTRY_URL: "likeminds.azurecr.io"
      AZURE_AKS_CLUSTER_NAME: "test"
      AZURE_AKS_CLUSTER_RESOURCE_GROUP: "test-aks-rg"
      WORKLOAD_TYPE: "statefulset"


    steps:
    - name: Set Release Tag Variable using Github Release tag# and Base Image tag
      id: set-image-tag
      run: echo "RELEASE_TAG=${GITHUB_REF#refs/*/}-${BASE_IMAGE_TAG}" >> $GITHUB_ENV
      # Creates the release tag that the docker image will be created

    - name: Checkout GitOps repository
      uses: actions/checkout@v4
      
    - name: Set executable permission
      run: chmod +x .github/workflows/workflow-steps.sh

    - name: Build and push Ping Directory Docker image to ACR
      run: .github/workflows/workflow-steps.sh build_ping_image

    - name: Deploy PingDirectory to DEV
      env:
        NAMESPACE: "ciam-dev"
      run: .github/workflows/workflow-steps.sh deploy_pingdirectory_dev

    - name: Check health of PingDirectory Statefulset
      env:
        NAMESPACE: "ciam-dev"
      run: .github/workflows/workflow-steps.sh post_deployment_healthcheck
    